<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>pgBackRest v2.13 C Code Coverage - command/info/info.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">pgBackRest v2.13 C Code Coverage</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">command/info</a> - info.c<span style="font-size: 80%;"> (source / <a href="info.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">all C unit</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">254</td>
            <td class="headerCovTableEntry">254</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2019-04-19 00:15:24</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">100</td>
            <td class="headerCovTableEntry">100</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data    Line data  Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :         : /***********************************************************************************************************************************</a>
<span class="lineNum">       2 </span>                :         : Info Command
<span class="lineNum">       3 </span>                :         : ***********************************************************************************************************************************/
<span class="lineNum">       4 </span>                :         : #include &lt;string.h&gt;
<span class="lineNum">       5 </span>                :         : #include &lt;sys/types.h&gt;
<span class="lineNum">       6 </span>                :         : #include &lt;time.h&gt;
<span class="lineNum">       7 </span>                :         : #include &lt;unistd.h&gt;
<span class="lineNum">       8 </span>                :         : 
<span class="lineNum">       9 </span>                :         : #include &quot;command/archive/common.h&quot;
<span class="lineNum">      10 </span>                :         : #include &quot;command/info/info.h&quot;
<span class="lineNum">      11 </span>                :         : #include &quot;common/debug.h&quot;
<span class="lineNum">      12 </span>                :         : #include &quot;common/io/handleWrite.h&quot;
<span class="lineNum">      13 </span>                :         : #include &quot;common/log.h&quot;
<span class="lineNum">      14 </span>                :         : #include &quot;common/memContext.h&quot;
<span class="lineNum">      15 </span>                :         : #include &quot;common/type/json.h&quot;
<span class="lineNum">      16 </span>                :         : #include &quot;config/config.h&quot;
<span class="lineNum">      17 </span>                :         : #include &quot;common/crypto/common.h&quot;
<span class="lineNum">      18 </span>                :         : #include &quot;info/info.h&quot;
<span class="lineNum">      19 </span>                :         : #include &quot;info/infoArchive.h&quot;
<span class="lineNum">      20 </span>                :         : #include &quot;info/infoBackup.h&quot;
<span class="lineNum">      21 </span>                :         : #include &quot;info/infoPg.h&quot;
<span class="lineNum">      22 </span>                :         : #include &quot;perl/exec.h&quot;
<span class="lineNum">      23 </span>                :         : #include &quot;postgres/interface.h&quot;
<span class="lineNum">      24 </span>                :         : #include &quot;storage/helper.h&quot;
<span class="lineNum">      25 </span>                :         : 
<span class="lineNum">      26 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">      27 </span>                :         : Constants
<span class="lineNum">      28 </span>                :         : ***********************************************************************************************************************************/
<span class="lineNum">      29 </span>                :         : STRING_STATIC(CFGOPTVAL_INFO_OUTPUT_TEXT_STR,                       &quot;text&quot;);
<span class="lineNum">      30 </span>                :         : 
<span class="lineNum">      31 </span>                :         : // Naming convention: &lt;sectionname&gt;_KEY_&lt;keyname&gt;_VAR. If the key exists in multiple sections, then &lt;sectionname&gt;_ is omitted.
<span class="lineNum">      32 </span>                :         : VARIANT_STRDEF_STATIC(ARCHIVE_KEY_MIN_VAR,                          &quot;min&quot;);
<span class="lineNum">      33 </span>                :         : VARIANT_STRDEF_STATIC(ARCHIVE_KEY_MAX_VAR,                          &quot;max&quot;);
<span class="lineNum">      34 </span>                :         : VARIANT_STRDEF_STATIC(BACKREST_KEY_FORMAT_VAR,                      &quot;format&quot;);
<span class="lineNum">      35 </span>                :         : VARIANT_STRDEF_STATIC(BACKREST_KEY_VERSION_VAR,                     &quot;version&quot;);
<span class="lineNum">      36 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_BACKREST_VAR,                      &quot;backrest&quot;);
<span class="lineNum">      37 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_INFO_VAR,                          &quot;info&quot;);
<span class="lineNum">      38 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_LABEL_VAR,                         &quot;label&quot;);
<span class="lineNum">      39 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_PRIOR_VAR,                         &quot;prior&quot;);
<span class="lineNum">      40 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_REFERENCE_VAR,                     &quot;reference&quot;);
<span class="lineNum">      41 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_TIMESTAMP_VAR,                     &quot;timestamp&quot;);
<span class="lineNum">      42 </span>                :         : VARIANT_STRDEF_STATIC(BACKUP_KEY_TYPE_VAR,                          &quot;type&quot;);
<span class="lineNum">      43 </span>                :         : VARIANT_STRDEF_STATIC(DB_KEY_ID_VAR,                                &quot;id&quot;);
<span class="lineNum">      44 </span>                :         : VARIANT_STRDEF_STATIC(DB_KEY_SYSTEM_ID_VAR,                         &quot;system-id&quot;);
<span class="lineNum">      45 </span>                :         : VARIANT_STRDEF_STATIC(DB_KEY_VERSION_VAR,                           &quot;version&quot;);
<span class="lineNum">      46 </span>                :         : VARIANT_STRDEF_STATIC(INFO_KEY_REPOSITORY_VAR,                      &quot;repository&quot;);
<span class="lineNum">      47 </span>                :         : VARIANT_STRDEF_STATIC(KEY_ARCHIVE_VAR,                              &quot;archive&quot;);
<span class="lineNum">      48 </span>                :         : VARIANT_STRDEF_STATIC(KEY_DATABASE_VAR,                             &quot;database&quot;);
<span class="lineNum">      49 </span>                :         : VARIANT_STRDEF_STATIC(KEY_DELTA_VAR,                                &quot;delta&quot;);
<span class="lineNum">      50 </span>                :         : VARIANT_STRDEF_STATIC(KEY_SIZE_VAR,                                 &quot;size&quot;);
<span class="lineNum">      51 </span>                :         : VARIANT_STRDEF_STATIC(KEY_START_VAR,                                &quot;start&quot;);
<span class="lineNum">      52 </span>                :         : VARIANT_STRDEF_STATIC(KEY_STOP_VAR,                                 &quot;stop&quot;);
<span class="lineNum">      53 </span>                :         : VARIANT_STRDEF_STATIC(STANZA_KEY_BACKUP_VAR,                        &quot;backup&quot;);
<span class="lineNum">      54 </span>                :         : VARIANT_STRDEF_STATIC(STANZA_KEY_CIPHER_VAR,                        &quot;cipher&quot;);
<span class="lineNum">      55 </span>                :         : VARIANT_STRDEF_STATIC(STANZA_KEY_NAME_VAR,                          &quot;name&quot;);
<span class="lineNum">      56 </span>                :         : VARIANT_STRDEF_STATIC(STANZA_KEY_STATUS_VAR,                        &quot;status&quot;);
<span class="lineNum">      57 </span>                :         : VARIANT_STRDEF_STATIC(STANZA_KEY_DB_VAR,                            &quot;db&quot;);
<span class="lineNum">      58 </span>                :         : VARIANT_STRDEF_STATIC(STATUS_KEY_CODE_VAR,                          &quot;code&quot;);
<span class="lineNum">      59 </span>                :         : VARIANT_STRDEF_STATIC(STATUS_KEY_MESSAGE_VAR,                       &quot;message&quot;);
<span class="lineNum">      60 </span>                :         : 
<span class="lineNum">      61 </span>                :         : #define INFO_STANZA_STATUS_OK                                       &quot;ok&quot;
<span class="lineNum">      62 </span>                :         : #define INFO_STANZA_STATUS_ERROR                                    &quot;error&quot;
<span class="lineNum">      63 </span>                :         : 
<span class="lineNum">      64 </span>                :         : #define INFO_STANZA_STATUS_CODE_OK                                  0
<span class="lineNum">      65 </span>                :         : STRING_STATIC(INFO_STANZA_STATUS_MESSAGE_OK_STR,                    &quot;ok&quot;);
<span class="lineNum">      66 </span>                :         : #define INFO_STANZA_STATUS_CODE_MISSING_STANZA_PATH                 1
<span class="lineNum">      67 </span>                :         : STRING_STATIC(INFO_STANZA_STATUS_MESSAGE_MISSING_STANZA_PATH_STR,   &quot;missing stanza path&quot;);
<span class="lineNum">      68 </span>                :         : #define INFO_STANZA_STATUS_CODE_NO_BACKUP                           2
<span class="lineNum">      69 </span>                :         : STRING_STATIC(INFO_STANZA_STATUS_MESSAGE_NO_BACKUP_STR,             &quot;no valid backups&quot;);
<span class="lineNum">      70 </span>                :         : #define INFO_STANZA_STATUS_CODE_MISSING_STANZA_DATA                 3
<span class="lineNum">      71 </span>                :         : STRING_STATIC(INFO_STANZA_STATUS_MESSAGE_MISSING_STANZA_DATA_STR,   &quot;missing stanza data&quot;);
<span class="lineNum">      72 </span>                :         : 
<span class="lineNum">      73 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">      74 </span>                :         : Set error status code and message for the stanza to the code and message passed.
<a name="75"><span class="lineNum">      75 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">      76 </span>                :         : static void
<span class="lineNum">      77 </span>                :<span class="lineCov">      15 : stanzaStatus(const int code, const String *message, Variant *stanzaInfo)</span>
<span class="lineNum">      78 </span>                :         : {
<span class="lineNum">      79 </span>                :<span class="lineCov">      15 :     FUNCTION_TEST_BEGIN();</span>
<span class="lineNum">      80 </span>                :<span class="lineCov">      15 :         FUNCTION_TEST_PARAM(INT, code);</span>
<span class="lineNum">      81 </span>                :<span class="lineCov">      15 :         FUNCTION_TEST_PARAM(STRING, message);</span>
<span class="lineNum">      82 </span>                :<span class="lineCov">      15 :         FUNCTION_TEST_PARAM(VARIANT, stanzaInfo);</span>
<span class="lineNum">      83 </span>                :         :     FUNCTION_TEST_END();
<span class="lineNum">      84 </span>                :         : 
<span class="lineNum">      85 </span>                :<span class="lineCov">      15 :     ASSERT(code &gt;= 0 &amp;&amp; code &lt;= 3);</span>
<span class="lineNum">      86 </span>                :<span class="lineCov">      15 :     ASSERT(message != NULL);</span>
<span class="lineNum">      87 </span>                :<span class="lineCov">      15 :     ASSERT(stanzaInfo != NULL);</span>
<span class="lineNum">      88 </span>                :         : 
<span class="lineNum">      89 </span>                :<span class="lineCov">      15 :     KeyValue *statusKv = kvPutKv(varKv(stanzaInfo), STANZA_KEY_STATUS_VAR);</span>
<span class="lineNum">      90 </span>                :         : 
<span class="lineNum">      91 </span>                :<span class="lineCov">      15 :     kvAdd(statusKv, STATUS_KEY_CODE_VAR, VARINT(code));</span>
<span class="lineNum">      92 </span>                :<span class="lineCov">      15 :     kvAdd(statusKv, STATUS_KEY_MESSAGE_VAR, VARSTR(message));</span>
<span class="lineNum">      93 </span>                :         : 
<span class="lineNum">      94 </span>                :<span class="lineCov">      15 :     FUNCTION_TEST_RETURN_VOID();</span>
<span class="lineNum">      95 </span>                :<span class="lineCov">      15 : }</span>
<span class="lineNum">      96 </span>                :         : 
<span class="lineNum">      97 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">      98 </span>                :         : Set the data for the archive section of the stanza for the database info from the backup.info file.
<a name="99"><span class="lineNum">      99 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">     100 </span>                :         : static void
<span class="lineNum">     101 </span>                :<span class="lineCov">      20 : archiveDbList(const String *stanza, const InfoPgData *pgData, VariantList *archiveSection, const InfoArchive *info, bool currentDb)</span>
<span class="lineNum">     102 </span>                :         : {
<span class="lineNum">     103 </span>                :<span class="lineCov">      20 :     FUNCTION_TEST_BEGIN();</span>
<span class="lineNum">     104 </span>                :<span class="lineCov">      20 :         FUNCTION_TEST_PARAM(STRING, stanza);</span>
<span class="lineNum">     105 </span>                :<span class="lineCov">      20 :         FUNCTION_TEST_PARAM_P(INFO_PG_DATA, pgData);</span>
<span class="lineNum">     106 </span>                :<span class="lineCov">      20 :         FUNCTION_TEST_PARAM(VARIANT, archiveSection);</span>
<span class="lineNum">     107 </span>                :<span class="lineCov">      20 :         FUNCTION_TEST_PARAM(BOOL, currentDb);</span>
<span class="lineNum">     108 </span>                :         :     FUNCTION_TEST_END();
<span class="lineNum">     109 </span>                :         : 
<span class="lineNum">     110 </span>                :<span class="lineCov">      20 :     ASSERT(stanza != NULL);</span>
<span class="lineNum">     111 </span>                :<span class="lineCov">      20 :     ASSERT(pgData != NULL);</span>
<span class="lineNum">     112 </span>                :<span class="lineCov">      20 :     ASSERT(archiveSection != NULL);</span>
<span class="lineNum">     113 </span>                :         : 
<span class="lineNum">     114 </span>                :         :     // With multiple DB versions, the backup.info history-id may not be the same as archive.info history-id, so the
<span class="lineNum">     115 </span>                :         :     // archive path must be built by retrieving the archive id given the db version and system id of the backup.info file.
<span class="lineNum">     116 </span>                :         :     // If there is no match, an error will be thrown.
<span class="lineNum">     117 </span>                :<span class="lineCov">      20 :     const String *archiveId = infoArchiveIdHistoryMatch(info, pgData-&gt;id, pgData-&gt;version, pgData-&gt;systemId);</span>
<span class="lineNum">     118 </span>                :         : 
<span class="lineNum">     119 </span>                :<span class="lineCov">      20 :     String *archivePath = strNewFmt(STORAGE_PATH_ARCHIVE &quot;/%s/%s&quot;, strPtr(stanza), strPtr(archiveId));</span>
<span class="lineNum">     120 </span>                :<span class="lineCov">      20 :     String *archiveStart = NULL;</span>
<span class="lineNum">     121 </span>                :<span class="lineCov">      20 :     String *archiveStop = NULL;</span>
<span class="lineNum">     122 </span>                :<span class="lineCov">      20 :     Variant *archiveInfo = varNewKv();</span>
<span class="lineNum">     123 </span>                :         : 
<span class="lineNum">     124 </span>                :         :     // Get a list of WAL directories in the archive repo from oldest to newest, if any exist
<span class="lineNum">     125 </span>                :<span class="lineCov">      20 :     StringList *walDir = storageListP(storageRepo(), archivePath, .expression = WAL_SEGMENT_DIR_REGEXP_STR);</span>
<span class="lineNum">     126 </span>                :         : 
<span class="lineNum">     127 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 13 times"> + </span>]:<span class="lineCov">      20 :     if (walDir != NULL)</span>
<span class="lineNum">     128 </span>                :         :     {
<span class="lineNum">     129 </span>                :<span class="lineCov">       7 :         unsigned int sizeWalDir = strLstSize(walDir);</span>
<span class="lineNum">     130 </span>                :         : 
<span class="lineNum">     131 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">       7 :         if (sizeWalDir &gt; 1)</span>
<span class="lineNum">     132 </span>                :<span class="lineCov">       4 :             walDir = strLstSort(walDir, sortOrderAsc);</span>
<span class="lineNum">     133 </span>                :         : 
<span class="lineNum">     134 </span>                :         :         // Not every WAL dir has WAL files so check each
<span class="lineNum">     135 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       9 :         for (unsigned int idx = 0; idx &lt; sizeWalDir; idx++)</span>
<span class="lineNum">     136 </span>                :         :         {
<span class="lineNum">     137 </span>                :         :             // Get a list of all WAL in this WAL dir
<span class="lineNum">     138 </span>                :<span class="lineCov">       7 :             StringList *list = storageListP(</span>
<span class="lineNum">     139 </span>                :         :                 storageRepo(), strNewFmt(&quot;%s/%s&quot;, strPtr(archivePath), strPtr(strLstGet(walDir, idx))),
<span class="lineNum">     140 </span>                :         :                 .expression = WAL_SEGMENT_FILE_REGEXP_STR);
<span class="lineNum">     141 </span>                :         : 
<span class="lineNum">     142 </span>                :         :             // If wal segments are found, get the oldest one as the archive start
<span class="lineNum">     143 </span>        [<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">       7 :             if (strLstSize(list) &gt; 0)</span>
<span class="lineNum">     144 </span>                :         :             {
<span class="lineNum">     145 </span>                :         :                 // Sort the list from oldest to newest to get the oldest starting WAL archived for this DB
<span class="lineNum">     146 </span>                :<span class="lineCov">       5 :                 list = strLstSort(list, sortOrderAsc);</span>
<span class="lineNum">     147 </span>                :<span class="lineCov">       5 :                 archiveStart = strSubN(strLstGet(list, 0), 0, 24);</span>
<span class="lineNum">     148 </span>                :<span class="lineCov">       5 :                 break;</span>
<span class="lineNum">     149 </span>                :         :             }
<span class="lineNum">     150 </span>                :         :         }
<span class="lineNum">     151 </span>                :         : 
<span class="lineNum">     152 </span>                :         :         // Iterate through the directory list in the reverse so processing newest first. Cast comparison to an int for readability.
<span class="lineNum">     153 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">      13 :         for (unsigned int idx = sizeWalDir - 1; (int)idx &gt;= 0; idx--)</span>
<span class="lineNum">     154 </span>                :         :         {
<span class="lineNum">     155 </span>                :         :             // Get a list of all WAL in this WAL dir
<span class="lineNum">     156 </span>                :<span class="lineCov">      11 :             StringList *list = storageListP(</span>
<span class="lineNum">     157 </span>                :         :                 storageRepo(), strNewFmt(&quot;%s/%s&quot;, strPtr(archivePath), strPtr(strLstGet(walDir, idx))),
<span class="lineNum">     158 </span>                :         :                 .expression = WAL_SEGMENT_FILE_REGEXP_STR);
<span class="lineNum">     159 </span>                :         : 
<span class="lineNum">     160 </span>                :         :             // If wal segments are found, get the newest one as the archive stop
<span class="lineNum">     161 </span>        [<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span>]:<span class="lineCov">      11 :             if (strLstSize(list) &gt; 0)</span>
<span class="lineNum">     162 </span>                :         :             {
<span class="lineNum">     163 </span>                :         :                 // Sort the list from newest to oldest to get the newest ending WAL archived for this DB
<span class="lineNum">     164 </span>                :<span class="lineCov">       5 :                 list = strLstSort(list, sortOrderDesc);</span>
<span class="lineNum">     165 </span>                :<span class="lineCov">       5 :                 archiveStop = strSubN(strLstGet(list, 0), 0, 24);</span>
<span class="lineNum">     166 </span>                :<span class="lineCov">       5 :                 break;</span>
<span class="lineNum">     167 </span>                :         :             }
<span class="lineNum">     168 </span>                :         :         }
<span class="lineNum">     169 </span>                :         :     }
<span class="lineNum">     170 </span>                :         : 
<span class="lineNum">     171 </span>                :         :     // If there is an archive or the database is the current database then store it
<span class="lineNum">     172 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 5 times"> + </span>]:<span class="lineCov">      20 :     if (currentDb || archiveStart != NULL)</span>
<span class="lineNum">     173 </span>                :         :     {
<span class="lineNum">     174 </span>                :         :         // Add empty database section to archiveInfo and then fill in database id from the backup.info
<span class="lineNum">     175 </span>                :<span class="lineCov">      15 :         KeyValue *databaseInfo = kvPutKv(varKv(archiveInfo), KEY_DATABASE_VAR);</span>
<span class="lineNum">     176 </span>                :         : 
<span class="lineNum">     177 </span>                :<span class="lineCov">      15 :         kvAdd(databaseInfo, DB_KEY_ID_VAR, VARUINT64(pgData-&gt;id));</span>
<span class="lineNum">     178 </span>                :         : 
<span class="lineNum">     179 </span>                :<span class="lineCov">      15 :         kvPut(varKv(archiveInfo), DB_KEY_ID_VAR, VARSTR(archiveId));</span>
<span class="lineNum">     180 </span>                :<span class="lineCov">      15 :         kvPut(varKv(archiveInfo), ARCHIVE_KEY_MIN_VAR, (archiveStart != NULL ? VARSTR(archiveStart) : (Variant *)NULL));</span>
<span class="lineNum">     181 </span>                :<span class="lineCov">      15 :         kvPut(varKv(archiveInfo), ARCHIVE_KEY_MAX_VAR, (archiveStop != NULL ? VARSTR(archiveStop) : (Variant *)NULL));</span>
<span class="lineNum">     182 </span>                :         : 
<span class="lineNum">     183 </span>                :<span class="lineCov">      15 :         varLstAdd(archiveSection, archiveInfo);</span>
<span class="lineNum">     184 </span>                :         :     }
<span class="lineNum">     185 </span>                :         : 
<span class="lineNum">     186 </span>                :<span class="lineCov">      20 :     FUNCTION_TEST_RETURN_VOID();</span>
<span class="lineNum">     187 </span>                :<span class="lineCov">      20 : }</span>
<span class="lineNum">     188 </span>                :         : 
<span class="lineNum">     189 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">     190 </span>                :         : For each current backup in the backup.info file of the stanza, set the data for the backup section.
<a name="191"><span class="lineNum">     191 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">     192 </span>                :         : static void
<span class="lineNum">     193 </span>                :<span class="lineCov">      11 : backupList(VariantList *backupSection, InfoBackup *info)</span>
<span class="lineNum">     194 </span>                :         : {
<span class="lineNum">     195 </span>                :<span class="lineCov">      11 :     FUNCTION_TEST_BEGIN();</span>
<span class="lineNum">     196 </span>                :<span class="lineCov">      11 :         FUNCTION_TEST_PARAM(VARIANT, backupSection);</span>
<span class="lineNum">     197 </span>                :<span class="lineCov">      11 :         FUNCTION_TEST_PARAM(INFO_BACKUP, info);</span>
<span class="lineNum">     198 </span>                :         :     FUNCTION_TEST_END();
<span class="lineNum">     199 </span>                :         : 
<span class="lineNum">     200 </span>                :<span class="lineCov">      11 :     ASSERT(backupSection != NULL);</span>
<span class="lineNum">     201 </span>                :<span class="lineCov">      11 :     ASSERT(info != NULL);</span>
<span class="lineNum">     202 </span>                :         : 
<span class="lineNum">     203 </span>                :         :     // For each current backup, get the label and corresponding data and build the backup section
<span class="lineNum">     204 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchCov" title="Branch 2 was taken 11 times"> + </span>]:<span class="lineCov">      19 :     for (unsigned int keyIdx = 0; keyIdx &lt; infoBackupDataTotal(info); keyIdx++)</span>
<span class="lineNum">     205 </span>                :         :     {
<span class="lineNum">     206 </span>                :         :         // Get the backup data
<span class="lineNum">     207 </span>                :<span class="lineCov">       8 :         InfoBackupData backupData = infoBackupData(info, keyIdx);</span>
<span class="lineNum">     208 </span>                :         : 
<span class="lineNum">     209 </span>                :<span class="lineCov">       8 :         Variant *backupInfo = varNewKv();</span>
<span class="lineNum">     210 </span>                :         : 
<span class="lineNum">     211 </span>                :         :         // main keys
<span class="lineNum">     212 </span>                :<span class="lineCov">       8 :         kvPut(varKv(backupInfo), BACKUP_KEY_LABEL_VAR, VARSTR(backupData.backupLabel));</span>
<span class="lineNum">     213 </span>                :<span class="lineCov">       8 :         kvPut(varKv(backupInfo), BACKUP_KEY_TYPE_VAR, VARSTR(backupData.backupType));</span>
<span class="lineNum">     214 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">       8 :         kvPut(</span>
<span class="lineNum">     215 </span>                :         :             varKv(backupInfo), BACKUP_KEY_PRIOR_VAR,
<span class="lineNum">     216 </span>                :<span class="lineCov">      12 :             (backupData.backupPrior != NULL ? VARSTR(backupData.backupPrior) : NULL));</span>
<span class="lineNum">     217 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">      12 :         kvPut(</span>
<span class="lineNum">     218 </span>                :         :             varKv(backupInfo), BACKUP_KEY_REFERENCE_VAR,
<span class="lineNum">     219 </span>                :<span class="lineCov">       4 :             (backupData.backupReference != NULL ? varNewVarLst(varLstNewStrLst(backupData.backupReference)) : NULL));</span>
<span class="lineNum">     220 </span>                :         : 
<span class="lineNum">     221 </span>                :         :         // archive section
<span class="lineNum">     222 </span>                :<span class="lineCov">       8 :         KeyValue *archiveInfo = kvPutKv(varKv(backupInfo), KEY_ARCHIVE_VAR);</span>
<span class="lineNum">     223 </span>                :         : 
<span class="lineNum">     224 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       8 :         kvAdd(</span>
<span class="lineNum">     225 </span>                :         :             archiveInfo, KEY_START_VAR,
<span class="lineNum">     226 </span>                :<span class="lineCov">      14 :             (backupData.backupArchiveStart != NULL ? VARSTR(backupData.backupArchiveStart) : NULL));</span>
<span class="lineNum">     227 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">       8 :         kvAdd(</span>
<span class="lineNum">     228 </span>                :         :             archiveInfo, KEY_STOP_VAR,
<span class="lineNum">     229 </span>                :<span class="lineCov">      12 :             (backupData.backupArchiveStop != NULL ? VARSTR(backupData.backupArchiveStop) : NULL));</span>
<span class="lineNum">     230 </span>                :         : 
<span class="lineNum">     231 </span>                :         :         // backrest section
<span class="lineNum">     232 </span>                :<span class="lineCov">       8 :         KeyValue *backrestInfo = kvPutKv(varKv(backupInfo), BACKUP_KEY_BACKREST_VAR);</span>
<span class="lineNum">     233 </span>                :         : 
<span class="lineNum">     234 </span>                :<span class="lineCov">       8 :         kvAdd(backrestInfo, BACKREST_KEY_FORMAT_VAR, VARUINT64(backupData.backrestFormat));</span>
<span class="lineNum">     235 </span>                :<span class="lineCov">       8 :         kvAdd(backrestInfo, BACKREST_KEY_VERSION_VAR, VARSTR(backupData.backrestVersion));</span>
<span class="lineNum">     236 </span>                :         : 
<span class="lineNum">     237 </span>                :         :         // database section
<span class="lineNum">     238 </span>                :<span class="lineCov">       8 :         KeyValue *dbInfo = kvPutKv(varKv(backupInfo), KEY_DATABASE_VAR);</span>
<span class="lineNum">     239 </span>                :         : 
<span class="lineNum">     240 </span>                :<span class="lineCov">       8 :         kvAdd(dbInfo, DB_KEY_ID_VAR, VARUINT64(backupData.backupPgId));</span>
<span class="lineNum">     241 </span>                :         : 
<span class="lineNum">     242 </span>                :         :         // info section
<span class="lineNum">     243 </span>                :<span class="lineCov">       8 :         KeyValue *infoInfo = kvPutKv(varKv(backupInfo), BACKUP_KEY_INFO_VAR);</span>
<span class="lineNum">     244 </span>                :         : 
<span class="lineNum">     245 </span>                :<span class="lineCov">       8 :         kvAdd(infoInfo, KEY_SIZE_VAR, VARUINT64(backupData.backupInfoSize));</span>
<span class="lineNum">     246 </span>                :<span class="lineCov">       8 :         kvAdd(infoInfo, KEY_DELTA_VAR, VARUINT64(backupData.backupInfoSizeDelta));</span>
<span class="lineNum">     247 </span>                :         : 
<span class="lineNum">     248 </span>                :         :         // info:repository section
<span class="lineNum">     249 </span>                :<span class="lineCov">       8 :         KeyValue *repoInfo = kvPutKv(infoInfo, INFO_KEY_REPOSITORY_VAR);</span>
<span class="lineNum">     250 </span>                :         : 
<span class="lineNum">     251 </span>                :<span class="lineCov">       8 :         kvAdd(repoInfo, KEY_SIZE_VAR, VARUINT64(backupData.backupInfoRepoSize));</span>
<span class="lineNum">     252 </span>                :<span class="lineCov">       8 :         kvAdd(repoInfo, KEY_DELTA_VAR, VARUINT64(backupData.backupInfoRepoSizeDelta));</span>
<span class="lineNum">     253 </span>                :         : 
<span class="lineNum">     254 </span>                :         :         // timestamp section
<span class="lineNum">     255 </span>                :<span class="lineCov">       8 :         KeyValue *timeInfo = kvPutKv(varKv(backupInfo), BACKUP_KEY_TIMESTAMP_VAR);</span>
<span class="lineNum">     256 </span>                :         : 
<span class="lineNum">     257 </span>                :<span class="lineCov">       8 :         kvAdd(timeInfo, KEY_START_VAR, VARUINT64(backupData.backupTimestampStart));</span>
<span class="lineNum">     258 </span>                :<span class="lineCov">       8 :         kvAdd(timeInfo, KEY_STOP_VAR, VARUINT64(backupData.backupTimestampStop));</span>
<span class="lineNum">     259 </span>                :         : 
<span class="lineNum">     260 </span>                :<span class="lineCov">       8 :         varLstAdd(backupSection, backupInfo);</span>
<span class="lineNum">     261 </span>                :         :     }
<span class="lineNum">     262 </span>                :         : 
<span class="lineNum">     263 </span>                :         : 
<span class="lineNum">     264 </span>                :<span class="lineCov">      11 :     FUNCTION_TEST_RETURN_VOID();</span>
<span class="lineNum">     265 </span>                :<span class="lineCov">      11 : }</span>
<span class="lineNum">     266 </span>                :         : 
<span class="lineNum">     267 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">     268 </span>                :         : Set the stanza data for each stanza found in the repo.
<a name="269"><span class="lineNum">     269 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">     270 </span>                :         : static VariantList *
<span class="lineNum">     271 </span>                :<span class="lineCov">      19 : stanzaInfoList(const String *stanza, StringList *stanzaList)</span>
<span class="lineNum">     272 </span>                :         : {
<span class="lineNum">     273 </span>                :<span class="lineCov">      15 :     FUNCTION_TEST_BEGIN();</span>
<span class="lineNum">     274 </span>                :<span class="lineCov">      15 :         FUNCTION_TEST_PARAM(STRING, stanza);</span>
<span class="lineNum">     275 </span>                :<span class="lineCov">      15 :         FUNCTION_TEST_PARAM(STRING_LIST, stanzaList);</span>
<span class="lineNum">     276 </span>                :         :     FUNCTION_TEST_END();
<span class="lineNum">     277 </span>                :         : 
<span class="lineNum">     278 </span>                :<span class="lineCov">      15 :     ASSERT(stanzaList != NULL);</span>
<span class="lineNum">     279 </span>                :         : 
<span class="lineNum">     280 </span>                :<span class="lineCov">      15 :     VariantList *result = varLstNew();</span>
<span class="lineNum">     281 </span>                :<span class="lineCov">      15 :     bool stanzaFound = false;</span>
<span class="lineNum">     282 </span>                :         : 
<span class="lineNum">     283 </span>                :         :     // Sort the list
<span class="lineNum">     284 </span>                :<span class="lineCov">      15 :     stanzaList = strLstSort(stanzaList, sortOrderAsc);</span>
<span class="lineNum">     285 </span>                :         : 
<span class="lineNum">     286 </span>        [<span class="branchCov" title="Branch 1 was taken 22 times"> + </span><span class="branchCov" title="Branch 2 was taken 13 times"> + </span>]:<span class="lineCov">      35 :     for (unsigned int idx = 0; idx &lt; strLstSize(stanzaList); idx++)</span>
<span class="lineNum">     287 </span>                :         :     {
<span class="lineNum">     288 </span>                :<span class="lineCov">      22 :         String *stanzaListName = strLstGet(stanzaList, idx);</span>
<span class="lineNum">     289 </span>                :         : 
<span class="lineNum">     290 </span>                :         :         // If a specific stanza has been requested and this is not it, then continue to the next in the list else indicate found
<span class="lineNum">     291 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">      22 :         if (stanza != NULL)</span>
<span class="lineNum">     292 </span>                :         :         {
<span class="lineNum">     293 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">      11 :             if (!strEq(stanza, stanzaListName))</span>
<span class="lineNum">     294 </span>                :<span class="lineCov">       7 :                 continue;</span>
<span class="lineNum">     295 </span>                :         :             else
<span class="lineNum">     296 </span>                :<span class="lineCov">       4 :                 stanzaFound = true;</span>
<span class="lineNum">     297 </span>                :         :         }
<span class="lineNum">     298 </span>                :         : 
<span class="lineNum">     299 </span>                :         :         // Create the stanzaInfo and section variables
<span class="lineNum">     300 </span>                :<span class="lineCov">      15 :         Variant *stanzaInfo = varNewKv();</span>
<span class="lineNum">     301 </span>                :<span class="lineCov">      15 :         VariantList *dbSection = varLstNew();</span>
<span class="lineNum">     302 </span>                :<span class="lineCov">      15 :         VariantList *backupSection = varLstNew();</span>
<span class="lineNum">     303 </span>                :<span class="lineCov">      15 :         VariantList *archiveSection = varLstNew();</span>
<span class="lineNum">     304 </span>                :<span class="lineCov">      15 :         InfoBackup *info = NULL;</span>
<span class="lineNum">     305 </span>                :         : 
<span class="lineNum">     306 </span>                :         :         // Catch certain errors
<span class="lineNum">     307 </span>                :<span class="lineCov">      48 :         TRY_BEGIN()</span>
<span class="lineNum">     308 </span>                :         :         {
<span class="lineNum">     309 </span>                :         :             // Attempt to load the backup info file
<span class="lineNum">     310 </span>                :<span class="lineCov">      30 :             info = infoBackupNew(</span>
<span class="lineNum">     311 </span>                :<span class="lineCov">      15 :                 storageRepo(), strNewFmt(STORAGE_PATH_BACKUP &quot;/%s/%s&quot;, strPtr(stanzaListName), INFO_BACKUP_FILE), false,</span>
<span class="lineNum">     312 </span>                :         :                 cipherType(cfgOptionStr(cfgOptRepoCipherType)), cfgOptionStr(cfgOptRepoCipherPass));
<span class="lineNum">     313 </span>                :         :         }
<span class="lineNum">     314 </span>                :<span class="lineCov">      18 :         CATCH(FileMissingError)</span>
<span class="lineNum">     315 </span>                :         :         {
<span class="lineNum">     316 </span>                :         :             // If there is no backup.info then set the status to indicate missing
<span class="lineNum">     317 </span>                :<span class="lineCov">       2 :             stanzaStatus(</span>
<span class="lineNum">     318 </span>                :         :                 INFO_STANZA_STATUS_CODE_MISSING_STANZA_DATA, INFO_STANZA_STATUS_MESSAGE_MISSING_STANZA_DATA_STR, stanzaInfo);
<span class="lineNum">     319 </span>                :         :         }
<span class="lineNum">     320 </span>                :<span class="lineCov">      16 :         CATCH(CryptoError)</span>
<span class="lineNum">     321 </span>                :         :         {
<span class="lineNum">     322 </span>                :         :             // If a reason for the error is due to a an ecryption error, add a hint
<span class="lineNum">     323 </span>                :<span class="lineCov">       1 :             THROW_FMT(</span>
<span class="lineNum">     324 </span>                :         :                 CryptoError,
<span class="lineNum">     325 </span>                :         :                 &quot;%s\n&quot;
<span class="lineNum">     326 </span>                :         :                 &quot;HINT: use option --stanza if encryption settings are different for the stanza than the global settings&quot;,
<span class="lineNum">     327 </span>                :         :                 errorMessage());
<span class="lineNum">     328 </span>                :         :         }
<span class="lineNum">     329 </span>                :         :         TRY_END();
<span class="lineNum">     330 </span>                :         : 
<span class="lineNum">     331 </span>                :         :         // Set the stanza name and cipher
<span class="lineNum">     332 </span>                :<span class="lineCov">      14 :         kvPut(varKv(stanzaInfo), STANZA_KEY_NAME_VAR, VARSTR(stanzaListName));</span>
<span class="lineNum">     333 </span>                :<span class="lineCov">      14 :         kvPut(varKv(stanzaInfo), STANZA_KEY_CIPHER_VAR, VARSTR(CIPHER_TYPE_NONE_STR));</span>
<span class="lineNum">     334 </span>                :         : 
<span class="lineNum">     335 </span>                :         :         // If the backup.info file exists, get the database history information (newest to oldest) and corresponding archive
<span class="lineNum">     336 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">      14 :         if (info != NULL)</span>
<span class="lineNum">     337 </span>                :         :         {
<span class="lineNum">     338 </span>                :         :             // Determine if encryption is enabled by checking for a cipher passphrase.  This is not ideal since it does not tell us
<span class="lineNum">     339 </span>                :         :             // what type of encryption is in use, but to figure that out we need a way to query the (possibly) remote repo to find
<span class="lineNum">     340 </span>                :         :             // out.  No such mechanism exists so this will have to do for now.  Probably the easiest thing to do is store the
<span class="lineNum">     341 </span>                :         :             // cipher type in the info file.
<span class="lineNum">     342 </span>        [<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 8 times"> + </span>]:<span class="lineCov">      12 :             if (infoPgCipherPass(infoBackupPg(info)) != NULL)</span>
<span class="lineNum">     343 </span>                :<span class="lineCov">       4 :                 kvPut(varKv(stanzaInfo), STANZA_KEY_CIPHER_VAR, VARSTR(CIPHER_TYPE_AES_256_CBC_STR));</span>
<span class="lineNum">     344 </span>                :         : 
<span class="lineNum">     345 </span>        [<span class="branchCov" title="Branch 2 was taken 21 times"> + </span><span class="branchCov" title="Branch 3 was taken 11 times"> + </span>]:<span class="lineCov">      32 :             for (unsigned int pgIdx = infoPgDataTotal(infoBackupPg(info)) - 1; (int)pgIdx &gt;= 0; pgIdx--)</span>
<span class="lineNum">     346 </span>                :         :             {
<span class="lineNum">     347 </span>                :<span class="lineCov">      21 :                 InfoPgData pgData = infoPgData(infoBackupPg(info), pgIdx);</span>
<span class="lineNum">     348 </span>                :<span class="lineCov">      21 :                 Variant *pgInfo = varNewKv();</span>
<span class="lineNum">     349 </span>                :         : 
<span class="lineNum">     350 </span>                :<span class="lineCov">      21 :                 kvPut(varKv(pgInfo), DB_KEY_ID_VAR, VARUINT64(pgData.id));</span>
<span class="lineNum">     351 </span>                :<span class="lineCov">      21 :                 kvPut(varKv(pgInfo), DB_KEY_SYSTEM_ID_VAR, VARUINT64(pgData.systemId));</span>
<span class="lineNum">     352 </span>                :<span class="lineCov">      21 :                 kvPut(varKv(pgInfo), DB_KEY_VERSION_VAR, VARSTR(pgVersionToStr(pgData.version)));</span>
<span class="lineNum">     353 </span>                :         : 
<span class="lineNum">     354 </span>                :<span class="lineCov">      21 :                 varLstAdd(dbSection, pgInfo);</span>
<span class="lineNum">     355 </span>                :         : 
<span class="lineNum">     356 </span>                :         :                 // Get the archive info for the DB from the archive.info file
<span class="lineNum">     357 </span>                :<span class="lineCov">      42 :                 InfoArchive *info = infoArchiveNew(</span>
<span class="lineNum">     358 </span>                :<span class="lineCov">      21 :                     storageRepo(), strNewFmt(STORAGE_PATH_ARCHIVE &quot;/%s/%s&quot;, strPtr(stanzaListName), INFO_ARCHIVE_FILE),  false,</span>
<span class="lineNum">     359 </span>                :         :                     cipherType(cfgOptionStr(cfgOptRepoCipherType)), cfgOptionStr(cfgOptRepoCipherPass));
<span class="lineNum">     360 </span>                :<span class="lineCov">      20 :                 archiveDbList(stanzaListName, &amp;pgData, archiveSection, info, (pgIdx == 0 ? true : false));</span>
<span class="lineNum">     361 </span>                :         :             }
<span class="lineNum">     362 </span>                :         : 
<span class="lineNum">     363 </span>                :         :             // Get data for all existing backups for this stanza
<span class="lineNum">     364 </span>                :<span class="lineCov">      11 :             backupList(backupSection, info);</span>
<span class="lineNum">     365 </span>                :         :         }
<span class="lineNum">     366 </span>                :         : 
<span class="lineNum">     367 </span>                :         :         // Add the database history, backup and archive sections to the stanza info
<span class="lineNum">     368 </span>                :<span class="lineCov">      13 :         kvPut(varKv(stanzaInfo), STANZA_KEY_DB_VAR, varNewVarLst(dbSection));</span>
<span class="lineNum">     369 </span>                :<span class="lineCov">      13 :         kvPut(varKv(stanzaInfo), STANZA_KEY_BACKUP_VAR, varNewVarLst(backupSection));</span>
<span class="lineNum">     370 </span>                :<span class="lineCov">      13 :         kvPut(varKv(stanzaInfo), KEY_ARCHIVE_VAR, varNewVarLst(archiveSection));</span>
<span class="lineNum">     371 </span>                :         : 
<span class="lineNum">     372 </span>                :         :         // If a status has not already been set and there are no backups then set status to no backup
<span class="lineNum">     373 </span>  [<span class="branchCov" title="Branch 2 was taken 11 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchCov" title="Branch 5 was taken 4 times"> + </span>]:<span class="lineCov">      24 :         if (kvGet(varKv(stanzaInfo), STANZA_KEY_STATUS_VAR) == NULL &amp;&amp;</span>
<span class="lineNum">     374 </span>                :<span class="lineCov">      11 :             varLstSize(kvGetList(varKv(stanzaInfo), STANZA_KEY_BACKUP_VAR)) == 0)</span>
<span class="lineNum">     375 </span>                :         :         {
<span class="lineNum">     376 </span>                :<span class="lineCov">       7 :             stanzaStatus(INFO_STANZA_STATUS_CODE_NO_BACKUP, INFO_STANZA_STATUS_MESSAGE_NO_BACKUP_STR, stanzaInfo);</span>
<span class="lineNum">     377 </span>                :         :         }
<span class="lineNum">     378 </span>                :         : 
<span class="lineNum">     379 </span>                :         :         // If a status has still not been set then set it to OK
<span class="lineNum">     380 </span>        [<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 9 times"> + </span>]:<span class="lineCov">      13 :         if (kvGet(varKv(stanzaInfo), STANZA_KEY_STATUS_VAR) == NULL)</span>
<span class="lineNum">     381 </span>                :<span class="lineCov">       4 :             stanzaStatus(INFO_STANZA_STATUS_CODE_OK, INFO_STANZA_STATUS_MESSAGE_OK_STR, stanzaInfo);</span>
<span class="lineNum">     382 </span>                :         : 
<span class="lineNum">     383 </span>                :<span class="lineCov">      13 :         varLstAdd(result, stanzaInfo);</span>
<span class="lineNum">     384 </span>                :         :     }
<span class="lineNum">     385 </span>                :         : 
<span class="lineNum">     386 </span>                :         :     // If looking for a specific stanza and it was not found, set minimum info and the status
<span class="lineNum">     387 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">      13 :     if (stanza != NULL &amp;&amp; !stanzaFound)</span>
<span class="lineNum">     388 </span>                :         :     {
<span class="lineNum">     389 </span>                :<span class="lineCov">       2 :         Variant *stanzaInfo = varNewKv();</span>
<span class="lineNum">     390 </span>                :         : 
<span class="lineNum">     391 </span>                :<span class="lineCov">       2 :         kvPut(varKv(stanzaInfo), STANZA_KEY_NAME_VAR, VARSTR(stanza));</span>
<span class="lineNum">     392 </span>                :         : 
<span class="lineNum">     393 </span>                :<span class="lineCov">       2 :         kvPut(varKv(stanzaInfo), STANZA_KEY_DB_VAR, varNewVarLst(varLstNew()));</span>
<span class="lineNum">     394 </span>                :<span class="lineCov">       2 :         kvPut(varKv(stanzaInfo), STANZA_KEY_BACKUP_VAR, varNewVarLst(varLstNew()));</span>
<span class="lineNum">     395 </span>                :         : 
<span class="lineNum">     396 </span>                :<span class="lineCov">       2 :         stanzaStatus(INFO_STANZA_STATUS_CODE_MISSING_STANZA_PATH, INFO_STANZA_STATUS_MESSAGE_MISSING_STANZA_PATH_STR, stanzaInfo);</span>
<span class="lineNum">     397 </span>                :<span class="lineCov">       2 :         varLstAdd(result, stanzaInfo);</span>
<span class="lineNum">     398 </span>                :         :     }
<span class="lineNum">     399 </span>                :         : 
<span class="lineNum">     400 </span>                :<span class="lineCov">      13 :     FUNCTION_TEST_RETURN(result);</span>
<span class="lineNum">     401 </span>                :         : }
<span class="lineNum">     402 </span>                :         : 
<span class="lineNum">     403 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">     404 </span>                :         : Format the text output for each database of the stanza.
<a name="405"><span class="lineNum">     405 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">     406 </span>                :         : static void
<span class="lineNum">     407 </span>                :<span class="lineCov">       7 : formatTextDb(const KeyValue *stanzaInfo, String *resultStr)</span>
<span class="lineNum">     408 </span>                :         : {
<span class="lineNum">     409 </span>                :<span class="lineCov">       7 :     FUNCTION_TEST_BEGIN();</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">       7 :         FUNCTION_TEST_PARAM(KEY_VALUE, stanzaInfo);</span>
<span class="lineNum">     411 </span>                :<span class="lineCov">       7 :         FUNCTION_TEST_PARAM(STRING, resultStr);</span>
<span class="lineNum">     412 </span>                :         :     FUNCTION_TEST_END();
<span class="lineNum">     413 </span>                :         : 
<span class="lineNum">     414 </span>                :<span class="lineCov">       7 :     ASSERT(stanzaInfo != NULL);</span>
<span class="lineNum">     415 </span>                :         : 
<span class="lineNum">     416 </span>                :<span class="lineCov">       7 :     VariantList *dbSection = kvGetList(stanzaInfo, STANZA_KEY_DB_VAR);</span>
<span class="lineNum">     417 </span>                :<span class="lineCov">       7 :     VariantList *archiveSection = kvGetList(stanzaInfo, KEY_ARCHIVE_VAR);</span>
<span class="lineNum">     418 </span>                :<span class="lineCov">       7 :     VariantList *backupSection = kvGetList(stanzaInfo, STANZA_KEY_BACKUP_VAR);</span>
<span class="lineNum">     419 </span>                :         : 
<span class="lineNum">     420 </span>                :         :     // For each database (working from oldest to newest) find the corresponding archive and backup info
<span class="lineNum">     421 </span>        [<span class="branchCov" title="Branch 1 was taken 12 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">      19 :     for (unsigned int dbIdx = 0; dbIdx &lt; varLstSize(dbSection); dbIdx++)</span>
<span class="lineNum">     422 </span>                :         :     {
<span class="lineNum">     423 </span>                :<span class="lineCov">      12 :         KeyValue *pgInfo = varKv(varLstGet(dbSection, dbIdx));</span>
<span class="lineNum">     424 </span>                :<span class="lineCov">      12 :         uint64_t dbId = varUInt64(kvGet(pgInfo, DB_KEY_ID_VAR));</span>
<span class="lineNum">     425 </span>                :         : 
<span class="lineNum">     426 </span>                :         :         // List is ordered so 0 is always the current DB index
<span class="lineNum">     427 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">      12 :         if (dbIdx == varLstSize(dbSection) - 1)</span>
<span class="lineNum">     428 </span>                :<span class="lineCov">       7 :             strCat(resultStr, &quot;\n    db (current)&quot;);</span>
<span class="lineNum">     429 </span>                :         : 
<span class="lineNum">     430 </span>                :         :         // Get the min/max archive information for the database
<span class="lineNum">     431 </span>                :<span class="lineCov">      12 :         String *archiveResult = strNew(&quot;&quot;);</span>
<span class="lineNum">     432 </span>                :         : 
<span class="lineNum">     433 </span>        [<span class="branchCov" title="Branch 1 was taken 16 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span>]:<span class="lineCov">      28 :         for (unsigned int archiveIdx = 0; archiveIdx &lt; varLstSize(archiveSection); archiveIdx++)</span>
<span class="lineNum">     434 </span>                :         :         {
<span class="lineNum">     435 </span>                :<span class="lineCov">      16 :             KeyValue *archiveInfo = varKv(varLstGet(archiveSection, archiveIdx));</span>
<span class="lineNum">     436 </span>                :<span class="lineCov">      16 :             KeyValue *archiveDbInfo = varKv(kvGet(archiveInfo, KEY_DATABASE_VAR));</span>
<span class="lineNum">     437 </span>                :<span class="lineCov">      16 :             uint64_t archiveDbId = varUInt64(kvGet(archiveDbInfo, DB_KEY_ID_VAR));</span>
<span class="lineNum">     438 </span>                :         : 
<span class="lineNum">     439 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">      16 :             if (archiveDbId == dbId)</span>
<span class="lineNum">     440 </span>                :         :             {
<span class="lineNum">     441 </span>                :<span class="lineCov">       8 :                 strCatFmt(</span>
<span class="lineNum">     442 </span>                :         :                     archiveResult, &quot;\n        wal archive min/max (%s): &quot;,
<span class="lineNum">     443 </span>                :         :                     strPtr(varStr(kvGet(archiveInfo, DB_KEY_ID_VAR))));
<span class="lineNum">     444 </span>                :         : 
<span class="lineNum">     445 </span>                :         :                 // Get the archive min/max if there are any archives for the database
<span class="lineNum">     446 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">       8 :                 if (kvGet(archiveInfo, ARCHIVE_KEY_MIN_VAR) != NULL)</span>
<span class="lineNum">     447 </span>                :         :                 {
<span class="lineNum">     448 </span>                :<span class="lineCov">       3 :                     strCatFmt(</span>
<span class="lineNum">     449 </span>                :         :                         archiveResult, &quot;%s/%s\n&quot;, strPtr(varStr(kvGet(archiveInfo, ARCHIVE_KEY_MIN_VAR))),
<span class="lineNum">     450 </span>                :         :                         strPtr(varStr(kvGet(archiveInfo, ARCHIVE_KEY_MAX_VAR))));
<span class="lineNum">     451 </span>                :         :                 }
<span class="lineNum">     452 </span>                :         :                 else
<span class="lineNum">     453 </span>                :<span class="lineCov">       5 :                     strCat(archiveResult, &quot;none present\n&quot;);</span>
<span class="lineNum">     454 </span>                :         :             }
<span class="lineNum">     455 </span>                :         :         }
<span class="lineNum">     456 </span>                :         : 
<span class="lineNum">     457 </span>                :         :         // Get the information for each current backup
<span class="lineNum">     458 </span>                :<span class="lineCov">      12 :         String *backupResult = strNew(&quot;&quot;);</span>
<span class="lineNum">     459 </span>                :         : 
<span class="lineNum">     460 </span>        [<span class="branchCov" title="Branch 1 was taken 10 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span>]:<span class="lineCov">      22 :         for (unsigned int backupIdx = 0; backupIdx &lt; varLstSize(backupSection); backupIdx++)</span>
<span class="lineNum">     461 </span>                :         :         {
<span class="lineNum">     462 </span>                :<span class="lineCov">      10 :             KeyValue *backupInfo = varKv(varLstGet(backupSection, backupIdx));</span>
<span class="lineNum">     463 </span>                :<span class="lineCov">      10 :             KeyValue *backupDbInfo = varKv(kvGet(backupInfo, KEY_DATABASE_VAR));</span>
<span class="lineNum">     464 </span>                :<span class="lineCov">      10 :             uint64_t backupDbId = varUInt64(kvGet(backupDbInfo, DB_KEY_ID_VAR));</span>
<span class="lineNum">     465 </span>                :         : 
<span class="lineNum">     466 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">      10 :             if (backupDbId == dbId)</span>
<span class="lineNum">     467 </span>                :         :             {
<span class="lineNum">     468 </span>                :<span class="lineCov">       5 :                 strCatFmt(</span>
<span class="lineNum">     469 </span>                :         :                     backupResult, &quot;\n        %s backup: %s\n&quot;, strPtr(varStr(kvGet(backupInfo, BACKUP_KEY_TYPE_VAR))),
<span class="lineNum">     470 </span>                :         :                     strPtr(varStr(kvGet(backupInfo, BACKUP_KEY_LABEL_VAR))));
<span class="lineNum">     471 </span>                :         : 
<span class="lineNum">     472 </span>                :<span class="lineCov">       5 :                 KeyValue *timestampInfo = varKv(kvGet(backupInfo, BACKUP_KEY_TIMESTAMP_VAR));</span>
<span class="lineNum">     473 </span>                :         : 
<span class="lineNum">     474 </span>                :         :                 // Get and format the backup start/stop time
<span class="lineNum">     475 </span>                :         :                 static char timeBufferStart[20];
<span class="lineNum">     476 </span>                :         :                 static char timeBufferStop[20];
<span class="lineNum">     477 </span>                :<span class="lineCov">       5 :                 time_t timeStart = (time_t) varUInt64(kvGet(timestampInfo, KEY_START_VAR));</span>
<span class="lineNum">     478 </span>                :<span class="lineCov">       5 :                 time_t timeStop = (time_t) varUInt64(kvGet(timestampInfo, KEY_STOP_VAR));</span>
<span class="lineNum">     479 </span>                :         : 
<span class="lineNum">     480 </span>                :<span class="lineCov">       5 :                 strftime(timeBufferStart, 20, &quot;%Y-%m-%d %H:%M:%S&quot;, localtime(&amp;timeStart));</span>
<span class="lineNum">     481 </span>                :<span class="lineCov">       5 :                 strftime(timeBufferStop, 20, &quot;%Y-%m-%d %H:%M:%S&quot;, localtime(&amp;timeStop));</span>
<span class="lineNum">     482 </span>                :         : 
<span class="lineNum">     483 </span>                :<span class="lineCov">       5 :                 strCatFmt(</span>
<span class="lineNum">     484 </span>                :         :                     backupResult, &quot;            timestamp start/stop: %s / %s\n&quot;, timeBufferStart, timeBufferStop);
<span class="lineNum">     485 </span>                :<span class="lineCov">       5 :                 strCat(backupResult, &quot;            wal start/stop: &quot;);</span>
<span class="lineNum">     486 </span>                :         : 
<span class="lineNum">     487 </span>                :<span class="lineCov">       5 :                 KeyValue *archiveDBackupInfo = varKv(kvGet(backupInfo, KEY_ARCHIVE_VAR));</span>
<span class="lineNum">     488 </span>                :         : 
<span class="lineNum">     489 </span>  [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span>]:<span class="lineCov">       8 :                 if (kvGet(archiveDBackupInfo, KEY_START_VAR) != NULL &amp;&amp;</span>
<span class="lineNum">     490 </span>                :<span class="lineCov">       3 :                     kvGet(archiveDBackupInfo, KEY_STOP_VAR) != NULL)</span>
<span class="lineNum">     491 </span>                :         :                 {
<span class="lineNum">     492 </span>                :<span class="lineCov">       2 :                     strCatFmt(backupResult, &quot;%s / %s\n&quot;, strPtr(varStr(kvGet(archiveDBackupInfo, KEY_START_VAR))),</span>
<span class="lineNum">     493 </span>                :         :                         strPtr(varStr(kvGet(archiveDBackupInfo, KEY_STOP_VAR))));
<span class="lineNum">     494 </span>                :         :                 }
<span class="lineNum">     495 </span>                :         :                 else
<span class="lineNum">     496 </span>                :<span class="lineCov">       3 :                     strCat(backupResult, &quot;n/a\n&quot;);</span>
<span class="lineNum">     497 </span>                :         : 
<span class="lineNum">     498 </span>                :<span class="lineCov">       5 :                 KeyValue *info = varKv(kvGet(backupInfo, BACKUP_KEY_INFO_VAR));</span>
<span class="lineNum">     499 </span>                :         : 
<span class="lineNum">     500 </span>                :<span class="lineCov">      10 :                 strCatFmt(</span>
<span class="lineNum">     501 </span>                :         :                     backupResult, &quot;            database size: %s, backup size: %s\n&quot;,
<span class="lineNum">     502 </span>                :<span class="lineCov">       5 :                     strPtr(strSizeFormat(varUInt64Force(kvGet(info, KEY_SIZE_VAR)))),</span>
<span class="lineNum">     503 </span>                :<span class="lineCov">       5 :                     strPtr(strSizeFormat(varUInt64Force(kvGet(info, KEY_DELTA_VAR)))));</span>
<span class="lineNum">     504 </span>                :         : 
<span class="lineNum">     505 </span>                :<span class="lineCov">       5 :                 KeyValue *repoInfo = varKv(kvGet(info, INFO_KEY_REPOSITORY_VAR));</span>
<span class="lineNum">     506 </span>                :         : 
<span class="lineNum">     507 </span>                :<span class="lineCov">      10 :                 strCatFmt(</span>
<span class="lineNum">     508 </span>                :         :                     backupResult, &quot;            repository size: %s, repository backup size: %s\n&quot;,
<span class="lineNum">     509 </span>                :<span class="lineCov">       5 :                     strPtr(strSizeFormat(varUInt64Force(kvGet(repoInfo, KEY_SIZE_VAR)))),</span>
<span class="lineNum">     510 </span>                :<span class="lineCov">       5 :                     strPtr(strSizeFormat(varUInt64Force(kvGet(repoInfo, KEY_DELTA_VAR)))));</span>
<span class="lineNum">     511 </span>                :         : 
<span class="lineNum">     512 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">       5 :                 if (kvGet(backupInfo, BACKUP_KEY_REFERENCE_VAR) != NULL)</span>
<span class="lineNum">     513 </span>                :         :                 {
<span class="lineNum">     514 </span>                :<span class="lineCov">       2 :                     StringList *referenceList = strLstNewVarLst(varVarLst(kvGet(backupInfo, BACKUP_KEY_REFERENCE_VAR)));</span>
<span class="lineNum">     515 </span>                :<span class="lineCov">       5 :                     strCatFmt(backupResult, &quot;            backup reference list: %s\n&quot;, strPtr(strLstJoin(referenceList, &quot;, &quot;)));</span>
<span class="lineNum">     516 </span>                :         :                 }
<span class="lineNum">     517 </span>                :         :             }
<span class="lineNum">     518 </span>                :         :         }
<span class="lineNum">     519 </span>                :         : 
<span class="lineNum">     520 </span>                :         :         // If there is data to display, then display it.
<span class="lineNum">     521 </span>[<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span>]:<span class="lineCov">      12 :         if (strSize(archiveResult) &gt; 0 || strSize(backupResult) &gt; 0)</span>
<span class="lineNum">     522 </span>                :         :         {
<span class="lineNum">     523 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">       9 :             if (dbIdx != varLstSize(dbSection) - 1)</span>
<span class="lineNum">     524 </span>                :<span class="lineCov">       2 :                 strCat(resultStr, &quot;\n    db (prior)&quot;);</span>
<span class="lineNum">     525 </span>                :         : 
<span class="lineNum">     526 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">       9 :             if (strSize(archiveResult) &gt; 0)</span>
<span class="lineNum">     527 </span>                :<span class="lineCov">       8 :                 strCat(resultStr, strPtr(archiveResult));</span>
<span class="lineNum">     528 </span>                :         : 
<span class="lineNum">     529 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span>]:<span class="lineCov">       9 :             if (strSize(backupResult) &gt; 0)</span>
<span class="lineNum">     530 </span>                :<span class="lineCov">       3 :                 strCat(resultStr, strPtr(backupResult));</span>
<span class="lineNum">     531 </span>                :         :         }
<span class="lineNum">     532 </span>                :         :     }
<span class="lineNum">     533 </span>                :<span class="lineCov">       7 :     FUNCTION_TEST_RETURN_VOID();</span>
<span class="lineNum">     534 </span>                :<span class="lineCov">       7 : }</span>
<span class="lineNum">     535 </span>                :         : 
<span class="lineNum">     536 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">     537 </span>                :         : Render the information for the stanza based on the command parameters.
<a name="538"><span class="lineNum">     538 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">     539 </span>                :         : static String *
<span class="lineNum">     540 </span>                :<span class="lineCov">      20 : infoRender(void)</span>
<span class="lineNum">     541 </span>                :         : {
<span class="lineNum">     542 </span>                :<span class="lineCov">      18 :     FUNCTION_LOG_VOID(logLevelDebug);</span>
<span class="lineNum">     543 </span>                :         : 
<span class="lineNum">     544 </span>                :<span class="lineCov">      18 :     String *result = NULL;</span>
<span class="lineNum">     545 </span>                :         : 
<span class="lineNum">     546 </span>                :<span class="lineCov">      56 :     MEM_CONTEXT_TEMP_BEGIN()</span>
<span class="lineNum">     547 </span>                :         :     {
<span class="lineNum">     548 </span>                :         :         // Get stanza if specified
<span class="lineNum">     549 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span>]:<span class="lineCov">      18 :         const String *stanza = cfgOptionTest(cfgOptStanza) ? cfgOptionStr(cfgOptStanza) : NULL;</span>
<span class="lineNum">     550 </span>                :         : 
<span class="lineNum">     551 </span>                :         :         // Get a list of stanzas in the backup directory.
<span class="lineNum">     552 </span>                :<span class="lineCov">      18 :         StringList *stanzaList = storageListP(storageRepo(), STORAGE_PATH_BACKUP_STR, .errorOnMissing = false);</span>
<span class="lineNum">     553 </span>                :<span class="lineCov">      18 :         VariantList *infoList = varLstNew();</span>
<span class="lineNum">     554 </span>                :<span class="lineCov">      18 :         String *resultStr = strNew(&quot;&quot;);</span>
<span class="lineNum">     555 </span>                :         : 
<span class="lineNum">     556 </span>                :         :         // If the backup storage exists, then search for and process any stanzas
<span class="lineNum">     557 </span>[<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 15 times"> + </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span>]:<span class="lineCov">      18 :         if (stanzaList != NULL &amp;&amp; strLstSize(stanzaList) &gt; 0)</span>
<span class="lineNum">     558 </span>                :<span class="lineCov">      15 :             infoList = stanzaInfoList(stanza, stanzaList);</span>
<span class="lineNum">     559 </span>                :         : 
<span class="lineNum">     560 </span>                :         :         // Format text output
<span class="lineNum">     561 </span>        [<span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchCov" title="Branch 3 was taken 7 times"> + </span>]:<span class="lineCov">      16 :         if (strEq(cfgOptionStr(cfgOptOutput), CFGOPTVAL_INFO_OUTPUT_TEXT_STR))</span>
<span class="lineNum">     562 </span>                :         :         {
<span class="lineNum">     563 </span>                :         :             // Process any stanza directories
<span class="lineNum">     564 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">       9 :             if  (varLstSize(infoList) &gt; 0)</span>
<span class="lineNum">     565 </span>                :         :             {
<span class="lineNum">     566 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">      15 :                 for (unsigned int stanzaIdx = 0; stanzaIdx &lt; varLstSize(infoList); stanzaIdx++)</span>
<span class="lineNum">     567 </span>                :         :                 {
<span class="lineNum">     568 </span>                :<span class="lineCov">       8 :                     KeyValue *stanzaInfo = varKv(varLstGet(infoList, stanzaIdx));</span>
<span class="lineNum">     569 </span>                :         : 
<span class="lineNum">     570 </span>                :         :                     // Add a carriage return between stanzas
<span class="lineNum">     571 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">       8 :                     if (stanzaIdx &gt; 0)</span>
<span class="lineNum">     572 </span>                :<span class="lineCov">       1 :                         strCatFmt(resultStr, &quot;\n&quot;);</span>
<span class="lineNum">     573 </span>                :         : 
<span class="lineNum">     574 </span>                :         :                     // Stanza name and status
<span class="lineNum">     575 </span>                :<span class="lineCov">       8 :                     strCatFmt(</span>
<span class="lineNum">     576 </span>                :         :                         resultStr, &quot;stanza: %s\n    status: &quot;, strPtr(varStr(kvGet(stanzaInfo, STANZA_KEY_NAME_VAR))));
<span class="lineNum">     577 </span>                :         : 
<span class="lineNum">     578 </span>                :         :                     // If an error has occurred, provide the information that is available and move onto next stanza
<span class="lineNum">     579 </span>                :<span class="lineCov">       8 :                     KeyValue *stanzaStatus = varKv(kvGet(stanzaInfo, STANZA_KEY_STATUS_VAR));</span>
<span class="lineNum">     580 </span>                :<span class="lineCov">       8 :                     int statusCode = varInt(kvGet(stanzaStatus, STATUS_KEY_CODE_VAR));</span>
<span class="lineNum">     581 </span>                :         : 
<span class="lineNum">     582 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       8 :                     if (statusCode != INFO_STANZA_STATUS_CODE_OK)</span>
<span class="lineNum">     583 </span>                :         :                     {
<span class="lineNum">     584 </span>                :<span class="lineCov">       6 :                         strCatFmt(</span>
<span class="lineNum">     585 </span>                :         :                             resultStr, &quot;%s (%s)\n&quot;, INFO_STANZA_STATUS_ERROR,
<span class="lineNum">     586 </span>                :         :                             strPtr(varStr(kvGet(stanzaStatus, STATUS_KEY_MESSAGE_VAR))));
<span class="lineNum">     587 </span>                :         : 
<span class="lineNum">     588 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">       6 :                         if (statusCode == INFO_STANZA_STATUS_CODE_MISSING_STANZA_DATA ||</span>
<span class="lineNum">     589 </span>                :         :                             statusCode == INFO_STANZA_STATUS_CODE_NO_BACKUP)
<span class="lineNum">     590 </span>                :         :                         {
<span class="lineNum">     591 </span>                :<span class="lineCov">       5 :                             strCatFmt(</span>
<span class="lineNum">     592 </span>                :         :                                 resultStr, &quot;    cipher: %s\n&quot;, strPtr(varStr(kvGet(stanzaInfo, STANZA_KEY_CIPHER_VAR))));
<span class="lineNum">     593 </span>                :         : 
<span class="lineNum">     594 </span>                :         :                             // If there is a backup.info file but no backups, then process the archive info
<span class="lineNum">     595 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">       5 :                             if (statusCode == INFO_STANZA_STATUS_CODE_NO_BACKUP)</span>
<span class="lineNum">     596 </span>                :<span class="lineCov">       4 :                                 formatTextDb(stanzaInfo, resultStr);</span>
<span class="lineNum">     597 </span>                :         :                         }
<span class="lineNum">     598 </span>                :         : 
<span class="lineNum">     599 </span>                :<span class="lineCov">       6 :                         continue;</span>
<span class="lineNum">     600 </span>                :         :                     }
<span class="lineNum">     601 </span>                :         :                     else
<span class="lineNum">     602 </span>                :<span class="lineCov">       2 :                         strCatFmt(resultStr, &quot;%s\n&quot;, INFO_STANZA_STATUS_OK);</span>
<span class="lineNum">     603 </span>                :         : 
<span class="lineNum">     604 </span>                :         :                     // Cipher
<span class="lineNum">     605 </span>                :<span class="lineCov">       2 :                     strCatFmt(resultStr, &quot;    cipher: %s\n&quot;,</span>
<span class="lineNum">     606 </span>                :         :                         strPtr(varStr(kvGet(stanzaInfo, STANZA_KEY_CIPHER_VAR))));
<span class="lineNum">     607 </span>                :         : 
<span class="lineNum">     608 </span>                :<span class="lineCov">       2 :                     formatTextDb(stanzaInfo, resultStr);</span>
<span class="lineNum">     609 </span>                :         :                 }
<span class="lineNum">     610 </span>                :         :             }
<span class="lineNum">     611 </span>                :         :             else
<span class="lineNum">     612 </span>                :<span class="lineCov">       9 :                 resultStr = strNew(&quot;No stanzas exist in the repository.\n&quot;);</span>
<span class="lineNum">     613 </span>                :         :         }
<span class="lineNum">     614 </span>                :         :         // Format json output
<span class="lineNum">     615 </span>                :         :         else
<span class="lineNum">     616 </span>                :<span class="lineCov">       7 :             resultStr = varToJson(varNewVarLst(infoList), 4);</span>
<span class="lineNum">     617 </span>                :         : 
<span class="lineNum">     618 </span>                :<span class="lineCov">      16 :         memContextSwitch(MEM_CONTEXT_OLD());</span>
<span class="lineNum">     619 </span>                :<span class="lineCov">      16 :         result = strDup(resultStr);</span>
<span class="lineNum">     620 </span>                :<span class="lineCov">      16 :         memContextSwitch(MEM_CONTEXT_TEMP());</span>
<span class="lineNum">     621 </span>                :         :     }
<span class="lineNum">     622 </span>                :<span class="lineCov">      20 :     MEM_CONTEXT_TEMP_END();</span>
<span class="lineNum">     623 </span>                :         : 
<span class="lineNum">     624 </span>                :<span class="lineCov">      16 :     FUNCTION_LOG_RETURN(STRING, result);</span>
<span class="lineNum">     625 </span>                :         : }
<span class="lineNum">     626 </span>                :         : 
<span class="lineNum">     627 </span>                :         : /***********************************************************************************************************************************
<span class="lineNum">     628 </span>                :         : Render info and output to stdout
<a name="629"><span class="lineNum">     629 </span>                :         : ***********************************************************************************************************************************/</a>
<span class="lineNum">     630 </span>                :         : void
<span class="lineNum">     631 </span>                :<span class="lineCov">       1 : cmdInfo(void)</span>
<span class="lineNum">     632 </span>                :         : {
<span class="lineNum">     633 </span>                :<span class="lineCov">       1 :     FUNCTION_LOG_VOID(logLevelDebug);</span>
<span class="lineNum">     634 </span>                :         : 
<span class="lineNum">     635 </span>                :<span class="lineCov">       3 :     MEM_CONTEXT_TEMP_BEGIN()</span>
<span class="lineNum">     636 </span>                :         :     {
<span class="lineNum">     637 </span>                :<span class="lineCov">       1 :         ioHandleWriteOneStr(STDOUT_FILENO, infoRender());</span>
<span class="lineNum">     638 </span>                :         :     }
<span class="lineNum">     639 </span>                :<span class="lineCov">       1 :     MEM_CONTEXT_TEMP_END();</span>
<span class="lineNum">     640 </span>                :         : 
<span class="lineNum">     641 </span>                :<span class="lineCov">       1 :     FUNCTION_LOG_RETURN_VOID();</span>
<span class="lineNum">     642 </span>                :<span class="lineCov">       1 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
